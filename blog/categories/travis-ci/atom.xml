<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[分類：travis-ci | 快樂小碼農]]></title>
  <link href="http://copy0401.github.io/blog/categories/travis-ci/atom.xml" rel="self"/>
  <link href="http://copy0401.github.io/"/>
  <updated>2021-03-11T01:26:51+08:00</updated>
  <id>http://copy0401.github.io/</id>
  <author>
    <name><![CDATA[copy0401]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Travis CI]]></title>
    <link href="http://copy0401.github.io/blog/2016/09/07/travis-ci/"/>
    <updated>2016-09-07T05:56:05+08:00</updated>
    <id>http://copy0401.github.io/blog/2016/09/07/travis-ci</id>
    <content type="html"><![CDATA[<h2>Set Up SSH Keys (for repo deploy)</h2>

<pre><code>ssh-keygen -t rsa -b 4096 -C "copy0401@gmail.com"
</code></pre>

<p>1./Users/電腦使用者名稱/.ssh/id_rsa_deploy</p>

<p>2.輸入密碼 留白 Enter</p>

<p>3.再次輸入密碼 留白 Enter</p>

<p>會產生一組金鑰</p>

<p>公鑰: <code>id_rsa_deploy.pub</code></p>

<p>私鑰: <code>id_rsa_deploy</code></p>

<p>( 私鑰base64編碼: <code>id_rsa_deploy_base64</code> 後面會介紹 )</p>

<hr />

<h2>github repo add deploy key</h2>

<p>in copy0401/copy0401.github.io</p>

<blockquote><p><code>Settings</code> > <code>Deploy keys</code> > <code>add deploy key</code></p></blockquote>

<p>Title: <code>travis deploy</code></p>

<p>Key: 填入 <code>id_rsa_deploy.pub</code> 公鑰內容</p>

<pre><code>ssh-rsa AAAAB3NzaC1yc2EA...gzR7LH/iSxYwxSbb9+Q== copy0401@gmail.com
</code></pre>

<hr />

<h2>github token (public_repo)</h2>

<p>github.com > <code>your_settings</code> ><code>Developer settings</code> > <code>Personal access tokens</code> > <code>Generate new token</code></p>

<p>note: Travis access</p>

<p>Select scopes : public_repo</p>

<p>Generate token = > <code>123a1c1ed1dfa1fc1234b123456a12abd1234567</code></p>

<hr />

<h2>GH_TOKEN</h2>

<pre><code>gem install travis
</code></pre>

<pre><code>travis encrypt 'GH_TOKEN=123a1c1ed1dfa1fc1234b123456a12abd1234567' --add
</code></pre>

<p>or</p>

<pre><code>travis encrypt 'GIT_NAME="copy0401" GIT_EMAIL=copy0401@gmail.com GH_TOKEN=123a1c1ed1dfa1fc1234b123456a12abd1234567' --add
</code></pre>

<p><code>.travis.yml</code> 中增加 <code>GH_TOKEN=[secure]</code></p>

<pre><code>travis login --pro  --auto
travis encrypt SOMEVAR="secretvalue" --add
</code></pre>

<p><code>.travis.yml</code> 中增加 <code>SOMEVAR=[secure]</code></p>

<hr />

<h2>To generate secure SSH deploy key for a github repo to be used from Travis</h2>

<p>參考: <a href="https://gist.github.com/floydpink/4631240">https://gist.github.com/floydpink/4631240</a></p>

<pre><code>base64 --break=0 ~/.ssh/id_rsa_deploy &gt; ~/.ssh/id_rsa_deploy_base64
</code></pre>

<p><code>id_rsa_deploy</code> 轉換為base64編碼為 <code>id_rsa_deploy_base64</code></p>

<pre><code>ENCRYPTION_FILTER="echo \$(echo \"- secure: \")\$(travis encrypt \"\$FILE='\`cat $FILE\`'\" -r copy0401/copy0401.github.io)"
</code></pre>

<pre><code>brew install coreutils 
gsplit --bytes=100 --numeric-suffixes --suffix-length=2 --filter="$ENCRYPTION_FILTER" ~/.ssh/id_rsa_deploy_base64 id_rsa_
</code></pre>

<blockquote><p>會產生約46行內容 貼到 <code>.travis.yml</code> 最後面 注意格式,前面加 <code> -</code></p></blockquote>

<pre><code>env:
  global:
  - secure: "rpdVrWM...xtOuONAE="
  - secure: "aJGiNmI...nzpD62Sk="
  - secure: "O1rEHB...Yu+xXGFQc="
    .
    .
    .
  - secure: "O1rEHB...pDCdFd3d="
</code></pre>

<p>修改 <code>.travis.yml</code> 內容
在 <code>before_script:</code> 下面增加這幾行內容</p>

<pre><code>before_script:
  - echo -n $id_rsa_{00..30} &gt;&gt; ~/.ssh/id_rsa_base64
  - base64 --decode --ignore-garbage ~/.ssh/id_rsa_base64 &gt; ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" &gt;&gt; ~/.ssh/config
</code></pre>

<hr />

<h2>.travis.yml</h2>

<pre><code>env:
  global:
  - GH_REPO="copy0401/copy0401.github.io" # 依照自己的 github_name/github_repo 設定
  - secure: "rpdVrWM...xtOuONAE=" # 解析後就是 GH_TOKEN 
  - secure: "x87sdje...in0xdase=" # 解析後就是 SOMEVAR
  - secure: "aJGiNmI...nzpD62Sk=" # 解析後就是 id_rsa_00
  - secure: "O1rEHB...Yu+xXGFQc=" # 解析後就是 id_rsa_01
  - secure: "nzpD6ec...xtOuONAE=" # 解析後就是 id_rsa_02
   .
   .
   .
  - secure: "nzpD6ec...xtOuONAE=" # 解析後就是 id_rsa_45
</code></pre>

<pre><code>travis encrypt 'GH_TOKEN=123a1c1ed1dfa1fc1234b123456a12abd1234567' --add
travis encrypt SOMEVAR="secretvalue" --add
gsplit --bytes=100 --numeric-suffixes --suffix-length=2 --filter="$ENCRYPTION_FILTER" ~/.ssh/id_rsa_deploy_base64 id_rsa_
</code></pre>

<p>修改內容 <a href="https://github.com/copy0401/copy0401.github.io/blob/source/.travis.yml">.travis.yml</a></p>
]]></content>
  </entry>
  
</feed>
